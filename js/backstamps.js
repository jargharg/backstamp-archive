var bsImageArray = [
{year: 1985, filename: "1985_sponge", description: "Spongeware", type: "S"}, 
{year: 1986, filename: "1986-1989_sponge", description: "Spongeware", type: "S"}, 
{year: 1987, filename: "1986-1989_sponge", description: "Spongeware", type: "S"}, 
{year: 1988, filename: "1986-1989_sponge", description: "Spongeware", type: "S"}, 
{year: 1989, filename: "1986-1989_sponge", description: "Spongeware", type: "S"}, 
{year: 1990, filename: "1990_sponge", description: "Spongeware", type: "S"}, 
{year: 1991, filename: "1991_sponge", description: "Spongeware", type: "S"}, 
{year: 1992, filename: "1992_sponge", description: "Spongeware", type: "S"}, 
{year: 1993, filename: "1993_sponge", description: "Spongeware", type: "S"}, 
{year: 1994, filename: "1994_sponge", description: "Spongeware", type: "S"}, 
{year: 1995, filename: "1995_sponge", description: "Spongeware", type: "S"}, 
{year: 1996, filename: "1996_sponge", description: "Spongeware", type: "S"}, 
{year: 1997, filename: "1997_sponge", description: "Spongeware", type: "S"}, 
{year: 1998, filename: "1998_countryliving", description: "Country Living Anniversary", type: "X"}, 
{year: 1998, filename: "1998_sponge", description: "Spongeware", type: "S"}, 
{year: 1999, filename: "1999_sponge", description: "Spongeware", type: "S"}, 
{year: 2000, filename: "2000_sponge", description: "Spongeware", type: "S"}, 
{year: 2001, filename: "2001_sponge", description: "Spongeware", type: "S"}, 
{year: 2002, filename: "2002_lovekisses", description: "Love & Kisses", type: "L"}, 
{year: 2002, filename: "2002_sponge1", description: "Spongeware", type: "S"}, 
{year: 2002, filename: "2002_sponge2", description: "Spongeware", type: "S"}, 
{year: 2003, filename: "2003_circus", description: "Circus", type: "L"}, 
{year: 2003, filename: "2003_menatwork", description: "Men at Work", type: "L"}, 
{year: 2003, filename: "2003_toys", description: "Toys", type: "L"}, 
{year: 2003, filename: "2003_sponge", description: "Spongeware", type: "S"}, 
{year: 2004, filename: "2004_catsdogs", description: "Cats & Dogs", type: "L"}, 
{year: 2004, filename: "2004_starrytoast", description: "Starry Toast", type: "L"}, 
{year: 2004, filename: "2004_sponge", description: "Spongeware", type: "S"}, 
{year: 2005, filename: "2005_sponge", description: "Spongeware", type: "S"}, 
{year: 2006, filename: "2006_sponge1", description: "Spongeware", type: "S"}, 
{year: 2006, filename: "2006_sponge2", description: "Spongeware", type: "S"}, 
{year: 2006, filename: "2006_sponge4", description: "Spongeware", type: "S"}, 
{year: 2007, filename: "2007_birds", description: "Birds", type: "L"}, 
{year: 2007, filename: "2007_sponge", description: "Spongeware", type: "S"}, 
{year: 2008, filename: "2008_sponge", description: "Spongeware", type: "S"}, 
{year: 2009, filename: "2009_gymkhana", description: "Gymkhana", type: "X"}, 
{year: 2009, filename: "2009_whitetoast", description: "White Toast", type: "L"}, 
{year: 2009, filename: "2009_sponge", description: "Spongeware", type: "S"}, 
{year: 2010, filename: "2010_hfh", description: "Help for Heroes", type: "X"}, 
{year: 2010, filename: "2010_sponge1", description: "Spongeware", type: "S"}, 
{year: 2010, filename: "2010_sponge2", description: "Spongeware Cookware", type: "S"}, 
{year: 2011, filename: "2011_willkate", description: "William and Kate's Marriage", type: "L"}, 
{year: 2011, filename: "2011_sponge1", description: "Spongeware", type: "S"}, 
{year: 2011, filename: "2011_sponge2", description: "Kitchenware", type: "S"}, 
{year: 2011, filename: "2011_sponge7", description: "Spongeware", type: "S"}, 
{year: 2012, filename: "2012_60years", description: "60 Years a Queen", type: "L"}, 
{year: 2012, filename: "2012_sponge1", description: "Spongeware", type: "S"}, 
{year: 2012, filename: "2012_sponge3", description: "Spongeware", type: "S"}, 
{year: 2013, filename: "2013_coronation", description: "60th Coronation Anniversary", type: "L"}, 
{year: 2013, filename: "2013_skyline", description: "Skyline", type: "L"}, 
{year: 2013, filename: "2013_sponge1", description: "Spongeware", type: "S"}, 
{year: 2013, filename: "2013_sponge4", description: "Spongeware", type: "S"}, 
{year: 2014, filename: "2014_dogs", description: "Dogs", type: "L"}, 
{year: 2014, filename: "2014_williamson", description: "Williamson Tea", type: "X"}, 
{year: 2014, filename: "2014_yitc", description: "Year in the Country", type: "L"}, 
{year: 2014, filename: "2014_sponge1", description: "Spongeware", type: "S"}, 
{year: 2014, filename: "2014_sponge4", description: "Spongeware", type: "S"}, 
{year: 2015, filename: "2015_blackdresser", description: "Black Dresser", type: "L"}, 
{year: 2015, filename: "2015_fox", description: "Fox and Leaves", type: "L"}, 
{year: 2015, filename: "2015_partridge", description: "Partridge", type: "L"}, 
{year: 2015, filename: "2015_tam", description: "Toast & Marmalade", type: "L"}, 
{year: 2015, filename: "2015_sponge1", description: "Spongeware", type: "S"}, 
{year: 2016, filename: "2016_birds", description: "Birds", type: "L"}, 
{year: 2016, filename: "2016_chickens", description: "Lots of Chickens", type: "L"}, 
{year: 2016, filename: "2016_crab", description: "Crab", type: "L"}, 
{year: 2016, filename: "2016_dogs", description: "Dogs", type: "L"}, 
{year: 2016, filename: "2016_flowers", description: "Flowers", type: "L"}, 
{year: 2016, filename: "2016_gamebirds", description: "Game Birds", type: "L"}, 
{year: 2016, filename: "2016_owls", description: "Owls", type: "L"}, 
{year: 2016, filename: "2016_owls1", description: "Owls", type: "L"}, 
{year: 2016, filename: "2016_RHS", description: "Chelsea Flower Show", type: "X"}, 
{year: 2016, filename: "2016_3kings", description: "Three Kings", type: "L"}, 
{year: 2016, filename: "2016_beardedtit", description: "Bearded Tit", type: "L"}, 
{year: 2016, filename: "2016_sponge1", description: "Spongeware", type: "S"}, 
{year: 2017, filename: "2017_sponge", description: "Spongeware", type: "S"}
]
var $yearContainer = $("#yearContainer")
var liveImgPrefix = (window.location.href.indexOf("emmabridgewater.co.uk") != -1) ? "https://www.emmabridgewater.co.uk/content/ebiz/eb/" : ""
var bsImageArray
var yearArray = []
var years
var currentYear
var filter

// return input sorted with S first, L middle and X last - input array must be ordered by year
function sortArray(arrayToSort) {
	currentYear = arrayToSort[0].year
	var sortedArray = []
	var sLocation = -1
	var lLocation = 0
	var i=0

	while (i<arrayToSort.length){
		if(arrayToSort[i].year === currentYear){
			if (arrayToSort[i].type === "S") {
				sortedArray.splice(sLocation+1,0,arrayToSort[i])
				sLocation++
				lLocation++
			} else if (arrayToSort[i].type === "L") {
				sortedArray.splice(lLocation,0,arrayToSort[i])
				lLocation++
			} else {
				sortedArray.splice(lLocation+10,0,arrayToSort[i])
			}
			i++
		} else { // updates currentYear and S/L locations if current array record is in a later year, then runs sorting again on the record
			currentYear = arrayToSort[i].year
			sLocation = i-1
			lLocation = i
		}
	}
	return sortedArray
}

// return number of unique years in array
function countYears(arrayToCount) {
	return arrayToCount[arrayToCount.length-1].year - arrayToCount[0].year + 1
}

// create yearCells and imgCells and append to yearContainer
function createGrid(){
	for (i = 0; i < years; i++) {
		var $newYearCell = $("<li />")
		.addClass("gridCell yearCell visYearCell")
		.append(
			$("<text />")
			.html(1985+i+"<i class='icon-right-marker icon-large'></i>")
			.addClass("yearNum centreCell")
			)
		yearArray.push($newYearCell)

		currentYear = 1985+i
		var currentYearBsArray = []

		// !!! can this be optimised? e.g. set new start point from array, exit when new year
		for (j = 0; j < bsImageArray.length; j++) { // puts all relevant images into current year backstamp array
			if (bsImageArray[j].year == currentYear) currentYearBsArray.push(bsImageArray[j])
		}

		currentYearBsArray.forEach(function(bsCell){
			var $newImgCell = $("<li />")
			.addClass("gridCell imgCell")
			.attr({
				"data-display": 1,
				"data-img": bsCell.filename,
				"data-bsType": bsCell.type,
				"data-desc": bsCell.description
			})
			.append(
				$("<img />")
				.addClass("bsImg")
				.attr({
					src: liveImgPrefix + "images/backstamps/s/"+bsCell.filename+"_s.jpg",
					alt: bsCell.description
					})
				)
			$newYearCell.push($newImgCell) // adds image cell to array with current year window at the start
		})
	}

	yearArray.forEach(function(year){
		$yearContainer.append(year[0]) // adds first year window and then images after
		for (j = 1; j < year.length; j++) { // scans through images in that year
			$yearContainer.append(year[j]) // adds first year window and then images after
			year[j].click(clickImg(year[j]))
		}
	})
	$yearContainer.after($("<div id = 'detailHeight'></div>")) // allows us to get height of detailContainerE
}

// load detailContainers and spacerCells
function addDetailContainers(){
	$(".detailContainer").remove()
	$(".spacerCell").parent().remove()

	$(".activeBsImg").removeClass("activeBsImg")
	$gridCells = $(".gridCell")
	for(i=0; i<$gridCells.length; i++) {
		var $currentCell = $($gridCells[i])
		if($yearContainer.offset().left+$yearContainer.width()-$currentCell.offset().left-$currentCell.width() < 30 || i === $gridCells.length-1){
			if($currentCell.hasClass("visYearCell")) {
				$currentCell.before(
					$currentCell = $("<div />")
					.addClass("gridCell")
					.append(
						$("<div />")
						.addClass("spacerCell centreCell")
						)
					)
			}
			$currentCell.after(
				$("<div />")
				.addClass("detailContainer")
				)
		}
	}
	// square cells
	$(".gridCell").height($(".gridCell").width())
}

// select next or previous imgCell based on input "L" or "R"
function navigateCells(direction){
	var $parentCell = $(".activeBsImg").parent()
	;(direction === "L") ? $parentCell.prevAll(".imgCell:visible").first().click() : $parentCell.nextAll(".imgCell:visible").first().click()
}

// navigate cells using arrow keys
function addKBNavigation(){
	$(document).keydown(function(key){
		if(key.which == 37) {
			navigateCells("L")
		} else if (key.which == 39) {
			navigateCells("R")
		}
	})
}

// handle use of top filters
function loadOptions(){
	$(".filterOption").click(function(){
		$selectedFilter = $(this)

		if ($selectedFilter.hasClass("filterActive")) { // if active filter button has been clicked on, remove filters
			filter = null
			$selectedFilter.removeClass("filterActive")
			$("#viewAllButton").addClass("filterActive")
		} else { // checks which filter button has been clicked on
			filter = $selectedFilter.attr("data-filterType")
			$(".filterActive").removeClass("filterActive")
			$selectedFilter.addClass("filterActive")
		}

		// fades out yearContainer while cells are shown/hidden
		$("#yearContainer").css("opacity",0).delay(110).queue(function(next){
			if (filter) { // if a filter has been selected, checks if imgCell matches the filter type; displays cell if so, hides cell if not
				$(".imgCell[data-bsType="+filter+"]").attr("data-display",1)
				$(".imgCell[data-bsType!="+filter+"]").hide().attr("data-display",0)
			} else { // if view all clicked, set all cells to be displayed
				$(".imgCell").attr("data-display",1)
			}
			reloadGrid()
			$("#yearContainer").css("opacity",1)
			next()
		})
	})
}

// show/hide imgCells of selected year based on filter
function loadImgs(yearToDisplay) {
	$firstWindow = $(yearToDisplay[0])
	$firstWindow.children().html($firstWindow.children().html().substring(0,4))
	var validImages = 0

	for (j = 1; j < yearToDisplay.length; j++) {
		$imgDisplay = yearToDisplay[j]
		if($imgDisplay.attr("data-display") == 1) { // if filter is set to show the filtered backstamp type, proceed
			$imgDisplay.show()
			validImages++
		}
	}

	if (validImages === 0) {
		$firstWindow.removeClass("visYearCell")
	} else {
		$firstWindow.addClass("visYearCell")
		$firstWindow.children().html($firstWindow.children().html()+"<i class='icon-right-marker icon-large'></i>")
	}
}

// show/hide detailContainer with content for the img
function clickImg(img){
	return function(){
		// find next detailContainer
		var $nextDetailContainer = $(this).nextAll(".detailContainer").first()

		if($(this).children().hasClass("activeBsImg")) {
			// if clicking on currently selected cell
			hideDetails()
		} else {
			var prevBsImgTop = $(".activeBsImg")[0] ? $(".activeBsImg").offset().top :  null
			hideDetails()

			// create content for detailContainer
			$bsImgDetail = $("<div />")
			.addClass("bsImgDetail")
			.append(
				$("<img>")
				.hide()
				.load(function(){
					$(this).fadeIn(200)
				})
				.attr("src",liveImgPrefix + "images/backstamps/"+$(this).attr("data-img")+".jpg")
				)

			$bsDataDetail = $("<div />")
			.addClass("bsDataDetail")
			.append(
				$("<div />")
				.addClass("bsYear")
				.html($(this).attr("data-img").substring(0,4))
				)
			.append(
				$("<div />")
				.addClass("bsName")
				.html($(this).attr("data-desc"))
				)

			// expand next detailContainer and append content
			$(this).nextAll(".detailContainer").first().addClass("detailContainerE")
			.append(addNavigation())
			.append($bsDataDetail.hide().fadeIn(200))
			.append($bsImgDetail.hide().fadeIn(200))

			// re-arrange details for mobile screens
			if ($(window).width() < 600) $bsImgDetail.insertBefore($bsDataDetail)

			$(this).children().addClass("activeBsImg")

			// scroll to top of selected cell
			var currentBsImgTop = $(this).children().offset().top-8
			var scrollPoint = (prevBsImgTop > currentBsImgTop || prevBsImgTop === null) ? currentBsImgTop : currentBsImgTop - $("#detailHeight").height()
			$('html, body').clearQueue().animate({scrollTop: scrollPoint}, 200, 'swing')
		}
	}
}

// hide expanded detailContainer and un-highlights active img
function hideDetails(){
	$(".detailContainerE").removeClass("detailContainerE").empty()
	$(".activeBsImg").removeClass("activeBsImg")
}

// add navigation buttons to detailContainer
function addNavigation(){
	$newNav = $("<div />")
	.addClass("detailNav")
	.append(
		$("<span />")
		.addClass("detailBtn detailBtnNav")
		.html("<i class='icon-left-marker icon-large'></i>")
		.click(function(){navigateCells("L")})
		)
	.append(
		$("<span />")
		.addClass("detailBtn detailBtnNav")
		.html("<i class='icon-right-marker icon-large'></i>")
		.click(function(){navigateCells("R")})
		)
	.append(
		$("<span />")
		.addClass("detailBtn detailBtnClose")
		.html("<i class='icon-close icon-large'></i>")
		.click(hideDetails)
		)
	return $newNav
}

// re-draw cells and detailContainers
function reloadGrid(){
	yearArray.forEach(function(year){ loadImgs(year) })
	addDetailContainers()
	$(".spacerCell").css("padding",0)
}

// Re-draw yearCells in IE to fix alignment issues
function IERefresh(){ 
	if (navigator.appVersion.indexOf("MSIE") > 0 || navigator.appVersion.indexOf("Trident") > 0) reloadGrid()
}


function initialiseBSApp(){
	bsImageArray = sortArray(bsImageArray)
	years = countYears(bsImageArray)
	createGrid()
	loadOptions()
	$("button[data-filterType='S']").click()
	addDetailContainers()
	addKBNavigation()
	navigateCells()
	IERefresh()
}

$(document).ready(function(){
	initialiseBSApp()
})

$(window).resize(function(){
	reloadGrid()
})